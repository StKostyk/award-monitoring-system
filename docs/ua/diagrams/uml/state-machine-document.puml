@startuml StateMachine_Document_UA
!theme plain
skinparam state {
    BackgroundColor<<uploading>> LightYellow
    BackgroundColor<<uploaded>> LightBlue
    BackgroundColor<<processing>> Orange
    BackgroundColor<<processed>> LightGreen
    BackgroundColor<<verified>> Green
    BackgroundColor<<manual>> LightCoral
    BackgroundColor<<archived>> DarkGray
    BackgroundColor<<failed>> Red
}

title Діаграма Скінченного Автомата Обробки Документа

[*] --> UPLOADING <<uploading>> : Користувач ініціює завантаження

state UPLOADING <<uploading>> {
    [*] --> Validating
    Validating --> FileTypeCheck : Перевірка типу файлу
    FileTypeCheck --> FileSizeCheck : Тип OK (PDF, JPG, PNG)
    FileSizeCheck --> Uploading : Розмір OK (< 10MB)
    Uploading --> [*] : Завантаження завершено
    
    FileTypeCheck --> UploadError : Невалідний тип файлу
    FileSizeCheck --> UploadError : Файл завеликий
    Uploading --> UploadError : Помилка завантаження
}

UPLOADING --> UPLOADED <<uploaded>> : Завантаження успішне
UPLOADING --> UPLOAD_FAILED <<failed>> : Завантаження невдале

state UPLOAD_FAILED <<failed>>

note right of UPLOAD_FAILED
    Користувач повідомлений про причину невдачі
    Можна повторити з валідним файлом
end note

UPLOAD_FAILED --> [*] : Користувач відмовляється
UPLOAD_FAILED --> UPLOADING : Користувач повторює

state UPLOADED <<uploaded>> {
    [*] --> StoredTemporarily
    StoredTemporarily --> QueuedForProcessing : Додано до черги ШІ
}

note right of UPLOADED
    Файл збережено в тимчасовому
    місці до ШІ-обробки
end note

UPLOADED --> PROCESSING <<processing>> : ШІ-обробка починається

state PROCESSING <<processing>> {
    [*] --> OCRInProgress
    OCRInProgress --> TextExtracted : OCR завершено
    TextExtracted --> NLPInProgress : Почати NLP аналіз
    NLPInProgress --> MetadataExtracted : NLP завершено
    MetadataExtracted --> ConfidenceCalculated : Розрахувати оцінки
    ConfidenceCalculated --> [*]
}

note right of PROCESSING
    Вилучені поля:
    - Назва нагороди
    - Організація-нагороджувач
    - Дата
    - Категорія (запропонована)
end note

PROCESSING --> PROCESSED <<processed>> : Обробка завершена\n[Впевненість >= 80%]
PROCESSING --> MANUAL_REVIEW <<manual>> : Обробка завершена\n[Впевненість < 80%]
PROCESSING --> PROCESS_FAILED <<failed>> : Помилка ШІ-сервісу

state PROCESS_FAILED <<failed>>

note right of PROCESS_FAILED
    ШІ-обробка невдала
    Потрібно повторити або ручне введення
end note

PROCESS_FAILED --> PROCESSING : Повторити ШІ-обробку
PROCESS_FAILED --> MANUAL_REVIEW : Перейти до ручного введення

state PROCESSED <<processed>> {
    [*] --> HighConfidence
    HighConfidence : Впевненість >= 80%
    HighConfidence : Форма автозаповнена
    HighConfidence : Користувач може переглянути/редагувати
}

note right of PROCESSED
    Результати з високою впевненістю
    автоматично заповнюють форму нагороди
    Користувач перевіряє перед поданням
end note

state MANUAL_REVIEW <<manual>> {
    [*] --> LowConfidence
    LowConfidence : Впевненість < 80%
    LowConfidence : Позначені поля підсвічено
    LowConfidence : Користувач повинен верифікувати/виправити
}

note right of MANUAL_REVIEW
    Поля з низькою впевненістю
    вимагають верифікації користувача
end note

PROCESSED --> VERIFIED <<verified>> : Нагороду подано\n& рецензент підтверджує
MANUAL_REVIEW --> VERIFIED <<verified>> : Користувач верифікує\n& нагороду подано

state VERIFIED <<verified>> {
    [*] --> DocumentVerified
    DocumentVerified : Сертифікат валідовано
    DocumentVerified : Метадані підтверджено
    DocumentVerified : Придатний для значка верифікації
}

note right of VERIFIED
    Верифіковані документи:
    - Відображають значок верифікації
    - Зберігаються постійно
    - Індексуються для пошуку
end note

VERIFIED --> PUBLISHED : Нагороду схвалено
PUBLISHED --> ARCHIVED <<archived>> : Період зберігання минув

state ARCHIVED <<archived>>

note right of ARCHIVED
    Архівовані документи:
    - Переміщено в холодне сховище
    - Метадані збережено
    - Файл може бути видалено згідно політики зберігання
end note

ARCHIVED --> [*]

' Шляхи відновлення після помилок
PROCESS_FAILED --> UPLOADED : Скинути для повторної спроби

' Адміністративне перевизначення
MANUAL_REVIEW --> VERIFIED : Адмін примусово верифікує

' Легенда
legend right
    |= Стан |= Опис |
    | UPLOADING | Файл завантажується |
    | UPLOADED | Готовий до ШІ-обробки |
    | PROCESSING | ШІ вилучає метадані |
    | PROCESSED | Вилучення з високою впевненістю |
    | MANUAL_REVIEW | Низька впевненість, потрібен користувач |
    | VERIFIED | Підтверджено рецензентом |
    | ARCHIVED | Період зберігання завершено |
    | FAILED | Сталася помилка |
endlegend

@enduml


