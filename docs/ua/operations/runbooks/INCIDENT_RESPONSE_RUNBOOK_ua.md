# Runbook реагування на інциденти
## Система моніторингу та відстеження нагород

> **Етап 17**: Документація та управління знаннями  
> **Версія документа**: 1.0  
> **Останнє оновлення**: Січень 2026  
> **Автор**: Стефан Костик  

---

## Рівні серйозності інцидентів

| Серйозність | Вплив | Час реагування | Приклади |
|-------------|-------|----------------|----------|
| **P1 - Критичний** | Система недоступна, втрата даних | 15 хв | Повний збій, порушення безпеки |
| **P2 - Високий** | Основна функція недоступна | 30 хв | Збій авторизації, блокування workflow |
| **P3 - Середній** | Погіршена продуктивність | 2 години | Повільні відповіді, часткова втрата функцій |
| **P4 - Низький** | Незначна проблема | 8 годин | Помилка UI, некритична помилка |

---

## Робочий процес реагування на інциденти

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Виявити    │───▶│  Оцінити    │───▶│  Вирішити   │───▶│ Post-Mort   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
     │                   │                   │                   │
  Оповіщення/       Оцінити            Виправити          Документувати
  Звіти           серйозність         та перевірити         уроки
```

---

## P1: Збій системи

### Симптоми
- Health endpoint повертає 5xx
- Немає працюючих подів у namespace
- Користувачі не можуть отримати доступ до додатку

### Негайні дії

```bash
# 1. Перевірити збій
curl -I https://api.award-system.edu.ua/actuator/health

# 2. Перевірити статус подів
kubectl get pods -n award-system

# 3. Перевірити останні події
kubectl get events -n award-system --sort-by='.lastTimestamp' | tail -20

# 4. Перевірити статус вузлів
kubectl get nodes
kubectl describe node <проблемний-вузол>
```

### Кроки відновлення

```bash
# Якщо поди падають
kubectl rollout undo deployment/award-backend -n award-system

# Якщо немає працюючих подів
kubectl scale deployment/award-backend --replicas=3 -n award-system

# Якщо база даних недоступна
kubectl delete pod -l app=award-backend -n award-system  # Примусовий перезапуск

# Якщо проблема кластера
# Негайно зверніться до інфраструктурної команди
```

### Шаблон комунікації

```
Тема: [P1] Збій системи нагород - Розслідування в процесі

Статус: РОЗСЛІДУВАННЯ
Час початку: [HH:MM UTC]
Вплив: Всі користувачі не можуть отримати доступ до системи

Поточні дії:
- Інженерна команда залучена
- Розслідування кореневої причини в процесі
- ETA наступного оновлення: 15 хвилин

Оновлення: [URL сторінки статусу]
```

---

## P2: Збій авторизації

### Симптоми
- Користувачі не можуть увійти
- 401 помилки на всіх авторизованих endpoints
- Помилки валідації JWT у логах

### Діагностика

```bash
# Перевірити логи сервісу авторизації
kubectl logs -l app=award-backend -n award-system | grep -i "auth\|jwt\|token"

# Перевірити конфігурацію OAuth2
kubectl get secret jwt-signing-key -o yaml

# Перевірити Redis (сховище сесій)
kubectl exec -it redis-0 -- redis-cli PING
```

### Вирішення

```bash
# Якщо JWT signing key пошкоджений
kubectl rollout restart deployment/award-backend

# Якщо проблема з підключенням Redis
kubectl delete pod redis-0  # StatefulSet перестворить

# Якщо OAuth2 провайдер недоступний
# Перевірте статус зовнішнього OAuth провайдера
# Переключіться на резервну авторизацію якщо доступна
```

---

## P2: Вичерпання пулу підключень до БД

### Симптоми
- Помилки таймауту в API відповідях
- "Connection pool exhausted" у логах
- Запити таймаутяться

### Діагностика

```bash
# Перевірити активні підключення
kubectl exec -it postgres-0 -- psql -U award_user -c \
  "SELECT count(*) FROM pg_stat_activity WHERE state = 'active';"

# Перевірити очікуючі запити
kubectl exec -it postgres-0 -- psql -U award_user -c \
  "SELECT * FROM pg_stat_activity WHERE wait_event IS NOT NULL;"

# Перевірити метрики пулу додатку
curl -s https://api.award-system.edu.ua/actuator/metrics/hikaricp.connections.active
```

### Вирішення

```bash
# Завершити довгі запити
kubectl exec -it postgres-0 -- psql -U award_user -c \
  "SELECT pg_terminate_backend(pid) FROM pg_stat_activity 
   WHERE state = 'active' AND query_start < NOW() - INTERVAL '5 minutes';"

# Збільшити розмір пулу (тимчасово)
kubectl set env deployment/award-backend \
  SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE=20

# Перезапустити додаток для скидання підключень
kubectl rollout restart deployment/award-backend
```

---

## P3: Висока затримка відповідей

### Симптоми
- P99 затримка > 500ms
- Користувачі повідомляють про повільне завантаження сторінок
- Спрацювання оповіщень Prometheus

### Діагностика

```bash
# Перевірити час відповіді
curl -w "@curl-format.txt" -s -o /dev/null \
  https://api.award-system.edu.ua/awards

# Перевірити використання ресурсів подів
kubectl top pods -n award-system

# Перевірити повільні запити БД
kubectl exec -it postgres-0 -- psql -U award_user -c \
  "SELECT query, mean_time, calls FROM pg_stat_statements 
   ORDER BY mean_time DESC LIMIT 10;"
```

### Вирішення

```bash
# Якщо обмеження CPU
kubectl scale deployment/award-backend --replicas=5

# Якщо обмеження пам'яті
kubectl set env deployment/award-backend JAVA_OPTS="-Xmx1g -Xms1g"

# Якщо обмеження БД
# Додайте відсутні індекси (див. аналіз повільних запитів)
# Розгляньте read репліки для звітних запитів

# Якщо зовнішній сервіс повільний
# Увімкніть circuit breaker / збільшіть таймаут
```

---

## P3: Оповіщення про дисковий простір

### Симптоми
- Використання диску > 80% оповіщення
- Помилки "No space left on device"
- Файли логів заповнюються

### Вирішення

```bash
# Перевірити використання диску
kubectl exec -it <pod> -- df -h

# Очистити старі логи
kubectl exec -it <pod> -- find /var/log -name "*.log" -mtime +7 -delete

# Очистити Docker образи (на вузлах)
docker system prune -af

# Для persistent volumes - збільшити PVC
kubectl patch pvc postgres-data -p '{"spec":{"resources":{"requests":{"storage":"100Gi"}}}}'
```

---

## Чек-лист після інциденту

| Крок | Завдання | Відповідальний | Виконано |
|------|----------|----------------|----------|
| 1 | Задокументована хронологія інциденту | Черговий | ☐ |
| 2 | Визначена коренева причина | Інженерія | ☐ |
| 3 | Надіслана комунікація клієнтам | Підтримка | ☐ |
| 4 | Визначені прогалини моніторингу | SRE | ☐ |
| 5 | Створені пункти дій | Тімлід | ☐ |
| 6 | Запланована зустріч post-mortem | Менеджер | ☐ |

---

## Шаблон Post-Mortem

```markdown
# Post-Mortem інциденту: [Назва]

## Підсумок
- **Дата**: РРРР-ММ-ДД
- **Тривалість**: X годин Y хвилин
- **Серйозність**: P1/P2/P3
- **Вплив**: X користувачів постраждало, Y% помилок

## Хронологія
- HH:MM - Інцидент виявлено
- HH:MM - Команда залучена
- HH:MM - Коренева причина визначена
- HH:MM - Виправлення розгорнуто
- HH:MM - Інцидент вирішено

## Коренева причина
[Технічний опис того, що пішло не так]

## Вирішення
[Що було зроблено для виправлення]

## Пункти дій
| Дія | Відповідальний | Дедлайн | Статус |
|-----|----------------|---------|--------|
| [Дія 1] | [Ім'я] | [Дата] | Відкрито |

## Уроки
- Що пройшло добре
- Що можна покращити
- Що ми будемо робити інакше
```

---

## Екстрені контакти

| Роль | Ім'я | Контакт | Доступність |
|------|------|---------|-------------|
| Основний черговий | [Ім'я] | [Телефон] | 24/7 |
| Запасний черговий | [Ім'я] | [Телефон] | 24/7 |
| Адмін бази даних | [Ім'я] | [Телефон] | Робочий час |
| Керівник безпеки | [Ім'я] | [Телефон] | 24/7 для P1 |
| Керівництво | [Ім'я] | [Телефон] | Тільки P1 |

---

## Пов'язані документи

- [Моніторинг та спостережуваність](../../monitoring/MONITORING_OBSERVABILITY_ua.md)
- [Runbook розгортання](./DEPLOYMENT_RUNBOOK_ua.md)
- [Посібник з усунення несправностей](../TROUBLESHOOTING_ua.md)

