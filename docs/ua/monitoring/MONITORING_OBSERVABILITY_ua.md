# Стратегія моніторингу та спостережуваності

> Система моніторингу та відстеження нагород - Документація Фази 15

## Огляд

Цей документ визначає стратегію моніторингу та спостережуваності для Системи моніторингу нагород, охоплюючи збір метрик, розподілене трасування, агрегацію логів та сповіщення.

### Стовпи спостережуваності

| Стовп | Технологія | Призначення |
|-------|-----------|-------------|
| **Метрики** | Prometheus + Micrometer | Моніторинг продуктивності, відстеження SLA |
| **Трасування** | Jaeger + OpenTelemetry | Розподілене трасування запитів |
| **Логування** | ELK Stack + Logstash | Централізована агрегація логів |
| **Сповіщення** | Alertmanager | Повідомлення про інциденти |
| **Візуалізація** | Grafana | Дашборди та аналітика |

---

## 1. Архітектура стеку спостережуваності

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Стек спостережуваності                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐         │
│   │   Backend   │────▶│  Prometheus │────▶│   Grafana   │         │
│   │  (Метрики)  │     │   :9090     │     │   :3000     │         │
│   └─────────────┘     └─────────────┘     └─────────────┘         │
│          │                   │                                     │
│          │            ┌──────┴──────┐                              │
│          │            │ Alertmanager│                              │
│          │            │    :9093    │                              │
│          │            └─────────────┘                              │
│          │                                                         │
│          ▼                                                         │
│   ┌─────────────┐     ┌─────────────┐                              │
│   │   Backend   │────▶│   Jaeger    │                              │
│   │ (Трасування)│     │   :16686    │                              │
│   └─────────────┘     └─────────────┘                              │
│          │                                                         │
│          ▼                                                         │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐         │
│   │   Backend   │────▶│  Logstash   │────▶│Elasticsearch│         │
│   │   (Логи)    │     │   :5000     │     │   :9200     │         │
│   └─────────────┘     └─────────────┘     └─────────────┘         │
│                                                  │                 │
│                                           ┌──────┴──────┐          │
│                                           │   Kibana    │          │
│                                           │   :5601     │          │
│                                           └─────────────┘          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Швидкий старт

```bash
# Запуск стеку спостережуваності
cd infra
docker-compose -f docker-compose.monitoring.yml up -d

# Доступ до дашбордів
# Grafana:      http://localhost:3000 (admin/admin)
# Prometheus:   http://localhost:9090
# Jaeger:       http://localhost:16686
# Kibana:       http://localhost:5601
# Alertmanager: http://localhost:9093
```

---

## 2. Конфігурація метрик

### 2.1 Інтеграція Micrometer

Застосунок використовує Micrometer з реєстром Prometheus для збору метрик.

### 2.2 Бізнес-метрики

| Метрика | Тип | Опис |
|---------|-----|------|
| `award.submissions.total` | Лічильник | Загальна кількість подань нагород за статусом |
| `award.approvals.total` | Лічильник | Затвердження за рівнем та рішенням |
| `award.requests.pending.total` | Вимірювач | Поточні очікуючі запити |
| `document.processing.time` | Таймер | Тривалість обробки документів |
| `document.processing.failures.total` | Лічильник | Помилки обробки |
| `user.registrations.total` | Лічильник | Реєстрації користувачів |
| `user.sessions.active` | Вимірювач | Активні сесії користувачів |

### 2.3 HTTP-метрики

Spring Boot Actuator автоматично надає:

| Метрика | Опис |
|---------|------|
| `http.server.requests` | Гістограма затримки HTTP-запитів |
| `http.server.requests.count` | Кількість запитів за статусом/URI |
| `jvm.memory.used` | Використання пам'яті JVM |
| `jvm.gc.pause` | Тривалість пауз GC |
| `hikaricp.connections.*` | Пул з'єднань з базою даних |

---

## 3. Розподілене трасування

### 3.1 Інтеграція OpenTelemetry

Трасування експортуються до Jaeger через протокол OTLP.

### 3.2 Використання анотації @Observed

```java
@Service
public class AwardWorkflowService {

    @Observed(name = "award.workflow.process",
              contextualName = "process-award-workflow")
    public void processWorkflow(Long awardId) {
        // Метод автоматично трасується
    }
}
```

---

## 4. Структуроване логування

### 4.1 Конфігурація Logback

**Розробка** (читабельний формат):
```
2024-01-15 10:30:45.123 INFO  [main] c.e.a.AwardService - Award submitted: ID=123
```

**Production** (JSON для ELK):
```json
{
  "timestamp": "2024-01-15T10:30:45.123Z",
  "level": "INFO",
  "logger_name": "c.e.a.AwardService",
  "message": "Award submitted: ID=123",
  "trace_id": "abc123",
  "span_id": "def456",
  "user_id": "user@example.com",
  "application": "award-monitoring-system",
  "environment": "production"
}
```

### 4.2 Рівні логування за середовищем

| Середовище | Кореневий рівень | Рівень застосунку |
|------------|------------------|-------------------|
| `local` | DEBUG | DEBUG |
| `dev` | INFO | DEBUG |
| `staging` | INFO | INFO |
| `production` | WARN | INFO |

---

## 5. Сповіщення та моніторинг SLA

### 5.1 Цільові показники SLA

| Метрика | Ціль | Поріг сповіщення |
|---------|------|------------------|
| **Час роботи** | 99.9% | Сервіс недоступний > 1хв |
| **Час відповіді P99** | < 200мс | > 200мс протягом 5хв |
| **Частота помилок** | < 0.1% | > 0.1% протягом 5хв |
| **Пам'ять JVM** | < 85% | > 85% протягом 5хв |

### 5.2 Категорії сповіщень

**Критичні** (негайна дія):
- Сервіс недоступний
- Частота помилок > 0.1%
- Час відповіді > 1с
- Пам'ять JVM > 95%
- Пул з'єднань БД вичерпано

**Попередження** (потребує розслідування):
- Час відповіді > 200мс
- Пам'ять JVM > 85%
- Високий час пауз GC
- Мало з'єднань БД

### 5.3 Канали сповіщень

| Канал | Випадок використання | Конфігурація |
|-------|---------------------|--------------|
| Webhook | Розробка | Отримувач за замовчуванням |
| Slack | Командні сповіщення | `#alerts-critical` |
| Email | Бізнес-стейкхолдери | Ротація чергових |
| PagerDuty | Критичні production | Управління інцидентами |

---

## 6. Дашборди Grafana

### 6.1 Дашборд огляду застосунку

**Включені панелі**:
- Статус сервісу (працює/не працює)
- Частота запитів (запитів/с)
- Затримка P99 (мс)
- Частота помилок (%)
- Частота запитів за ендпоінтом
- Перцентилі часу відповіді
- Heap-пам'ять JVM
- Пул з'єднань з БД

### 6.2 Корисні PromQL-запити

```promql
# Частота запитів
sum(rate(http_server_requests_seconds_count[5m]))

# Затримка P99
histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket[5m])) by (le))

# Частота помилок
sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) 
/ sum(rate(http_server_requests_seconds_count[5m])) * 100

# Використання пам'яті JVM
jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} * 100
```

---

## 7. Аналіз логів у Kibana

### 7.1 Налаштування індексу

1. Відкрийте Kibana за адресою `http://localhost:5601`
2. Перейдіть до **Stack Management** → **Index Patterns**
3. Створіть шаблон: `award-logs-*`
4. Встановіть поле часу: `@timestamp`

### 7.2 Корисні KQL-запити

```
# Помилки за останню годину
log_level:ERROR AND @timestamp >= now-1h

# Активність конкретного користувача
user_id:"user@example.com"

# Дослідження трасування
trace_id:"abc123"

# Логи подання нагород
log_message:*award* AND log_message:*submit*
```

---

## 8. Перевірки здоров'я

### 8.1 Kubernetes Probes

**Ендпоінти**:
- Liveness: `/actuator/health/liveness`
- Readiness: `/actuator/health/readiness`

---

## 9. Рекомендації для Production

### 9.1 Стратегія семплювання

| Середовище | Семплювання трасування | Рівень логів |
|------------|------------------------|--------------|
| Розробка | 100% | DEBUG |
| Staging | 50% | INFO |
| Production | 10% | WARN (INFO для застосунку) |

### 9.2 Політики зберігання

| Тип даних | Зберігання | Обсяг |
|-----------|------------|-------|
| Метрики (Prometheus) | 15 днів | ~1ГБ |
| Трасування (Jaeger) | 7 днів | ~5ГБ |
| Логи (Elasticsearch) | 30 днів | ~10ГБ |

### 9.3 Вимоги до ресурсів

| Сервіс | Пам'ять | CPU |
|--------|---------|-----|
| Prometheus | 512МБ | 0.5 |
| Grafana | 256МБ | 0.25 |
| Jaeger | 256МБ | 0.25 |
| Elasticsearch | 1ГБ | 1.0 |
| Kibana | 512МБ | 0.5 |
| Logstash | 512МБ | 0.5 |

---

## 10. Усунення неполадок

### Типові проблеми

| Проблема | Рішення |
|----------|---------|
| Метрики не з'являються | Перевірте ендпоінт `/actuator/prometheus` |
| Відсутні трасування | Перевірте з'єднання з OTLP endpoint |
| Логи не в Kibana | Перевірте конвеєр Logstash та з'єднання з ES |
| Високе використання пам'яті | Зменшіть retention, увімкніть семплювання |

---

**Версія**: 1.0  
**Останнє оновлення**: Січень 2026  
**Автор**: Стефан Костик

