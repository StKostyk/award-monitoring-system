# Стратегії Розгортання

> **Система Моніторингу Нагород - Фреймворк Управління Релізами**

## Огляд

Цей документ визначає стратегії розгортання для Системи Моніторингу Нагород, забезпечуючи релізи без простоїв, зменшення ризиків та надійні можливості відкату.

---

## Порівняння Стратегій Розгортання

| **Стратегія** | **Випадок Використання** | **Рівень Ризику** | **Час Відкату** | **Вартість Ресурсів** |
|---------------|--------------------------|-------------------|-----------------|----------------------|
| **Blue-Green** | Продакшн релізи | Низький | Миттєво | 2x інфраструктура |
| **Canary** | Валідація функцій | Низький | Швидко (хвилини) | +10-20% інфраструктура |
| **Rolling** | Рутинні оновлення | Середній | Середній (хвилини) | Та сама інфраструктура |
| **A/B Тестування** | Експерименти з функціями | Низький | Миттєво | +overhead feature flags |

---

## 1. Blue-Green Розгортання (Основна Продакшн Стратегія)

**Коли використовувати**: Всі продакшн релізи, що вимагають нульового простою.

### Архітектура
```
                    ┌─────────────────┐
                    │   Load Balancer │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              │              ▼
    ┌─────────────────┐     │    ┌─────────────────┐
    │  Blue (Активне) │     │    │  Green (Очікує) │
    │   v1.2.0        │◄────┘    │   v1.3.0        │
    └─────────────────┘          └─────────────────┘
```

### Процес
1. Розгорнути нову версію на **Green** середовище
2. Запустити автоматичні smoke тести на Green
3. Переключити load balancer на Green (миттєве переключення)
4. Тримати Blue запущеним для негайного відкату
5. Завершити Blue після періоду валідації (24 год)

### Kubernetes Імплементація
```yaml
# Переключення селектора сервісу
kubectl patch service award-service \
  -p '{"spec":{"selector":{"version":"green"}}}'
```

### Відкат
- **Час**: < 1 секунда (переключення селектора сервісу)
- **Команда**: Переключити селектор назад на blue

---

## 2. Canary Розгортання (Функції Високого Ризику)

**Коли використовувати**: Нові функції з невизначеним впливом на користувачів або характеристиками продуктивності.

### Патерн Розподілу Трафіку
```
┌──────────────────────────────────────────────┐
│                 Ingress Controller           │
│                                              │
│   ┌────────────────┐    ┌────────────────┐   │
│   │   90% Трафіку  │    │   10% Трафіку  │   │
│   │   (Стабільна)  │    │   (Canary)     │   │
│   └───────┬────────┘    └───────┬────────┘   │
│           │                     │            │
│           ▼                     ▼            │
│   ┌───────────────┐     ┌───────────────┐    │
│   │  v1.2.0       │     │  v1.3.0       │    │
│   │  (3 репліки)  │     │  (1 репліка)  │    │
│   └───────────────┘     └───────────────┘    │
└──────────────────────────────────────────────┘
```

### Поступовий Rollout
| Фаза | Canary Трафік | Тривалість | Критерії Успіху |
|------|---------------|------------|-----------------|
| 1 | 5% | 30 хв | Error rate < 0.1% |
| 2 | 25% | 2 години | P99 latency < 200ms |
| 3 | 50% | 4 години | Немає критичних алертів |
| 4 | 100% | - | Повна промоція |

### Тригер Відкату (Автоматичний)
- Error rate > 1%
- P99 latency > 500ms
- Спрацював критичний алерт

---

## 3. Rolling Розгортання (Рутинні Оновлення)

**Коли використовувати**: Зміни без порушення сумісності, оновлення залежностей, мінорні патчі.

### Процес
```
Час →
┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐
│ v1  │ │ v1  │ │ v1  │ │ v1  │  Початок
└─────┘ └─────┘ └─────┘ └─────┘
   ↓
┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐
│ v2  │ │ v1  │ │ v1  │ │ v1  │  Фаза 1
└─────┘ └─────┘ └─────┘ └─────┘
   ↓
┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐
│ v2  │ │ v2  │ │ v1  │ │ v1  │  Фаза 2
└─────┘ └─────┘ └─────┘ └─────┘
   ↓
┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐
│ v2  │ │ v2  │ │ v2  │ │ v2  │  Завершено
└─────┘ └─────┘ └─────┘ └─────┘
```

### Kubernetes Конфігурація
```yaml
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1        # Макс pods понад бажане
    maxUnavailable: 0  # Нульовий простій
```

---

## 4. A/B Тестування (Експерименти з Функціями)

**Коли використовувати**: Валідація функцій з конкретними сегментами користувачів перед повним rollout.

### Імплементація
- **Feature Flags**: LaunchDarkly, Unleash, або кастомне рішення
- **Сегментація Користувачів**: На основі ролей, географії, відсотка
- **Збір Метрик**: Analytics events по варіанту

### Приклади Використання
- Новий дизайн дашборду для керівників підрозділів
- Альтернативний workflow подання нагород
- Покращена функціональність пошуку

---

## Потік Промоції Середовищ

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Розробка  │───►│   Staging   │───►│     UAT     │───►│  Продакшн   │
│             │    │             │    │             │    │             │
│ Автоматичне │    │ Автоматичне │    │   Ручне     │    │  Blue-Green │
│ Розгортання │    │ Розгортання │    │ Погодження  │    │ Розгортання │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
     │                   │                  │                   │
     └───────────────────┴──────────────────┴───────────────────┘
                              CI/CD Pipeline
```

---

## Типи Релізів та Стратегії

| **Тип Релізу** | **Стратегія** | **Погодження** | **Таймлайн** |
|----------------|---------------|----------------|--------------|
| **Major (x.0.0)** | Blue-Green + Canary | Архітектурна рада | Квартально |
| **Minor (x.y.0)** | Blue-Green | Product Owner | Щомісяця |
| **Patch (x.y.z)** | Rolling | Tech Lead | За потреби |
| **Hotfix** | Blue-Green (прискорено) | On-call Manager | Негайно |

---

## Процедури Відкату

### Автоматичні Тригери Відкату
- Невдалі health checks (3 поспіль)
- Перевищено поріг error rate (>1%)
- Порушення порогу Memory/CPU
- Виявлено вразливість безпеки

### Команда Ручного Відкату
```bash
# Blue-Green відкат
kubectl patch service award-service \
  -p '{"spec":{"selector":{"version":"blue"}}}'

# Rolling deployment відкат
kubectl rollout undo deployment/award-backend -n production
```

---

## Health Checks

### Readiness Probe
```yaml
readinessProbe:
  httpGet:
    path: /actuator/health/readiness
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 5
```

### Liveness Probe
```yaml
livenessProbe:
  httpGet:
    path: /actuator/health/liveness
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
```

---

## Метрики Успіху

| Метрика | Ціль | Вимірювання |
|---------|------|-------------|
| Частота Розгортання | Щотижня | CI/CD метрики |
| Lead Time для Змін | < 1 день | Commit до продакшн |
| Рівень Невдалих Змін | < 5% | Невдалі розгортання |
| Середній Час Відновлення | < 15 хв | Вирішення інцидентів |

---

**Версія**: 1.0  
**Останнє Оновлення**: Січень 2026  
**Автор**: Стефан Костик

