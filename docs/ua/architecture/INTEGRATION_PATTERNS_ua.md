# Корпоративні шаблони інтеграції
## Архітектура системи моніторингу та відстеження нагород

> **Звітний документ фази 7**: Технічна стратегія та планування архітектури  
> **Версія документа**: 1.0  
> **Останнє оновлення**: Серпень 2025  
> **Автор**: Стефан Костик

---

## Виконавче резюме

Цей документ окреслює корпоративні шаблони інтеграції, прийняті для Системи моніторингу та відстеження нагород. Ці шаблони забезпечують масштабовану, супроводжувану та слабо зв'язану системну архітектуру, підтримуючи при цьому вимоги проекту щодо прозорості, відповідності GDPR та багатомовної підтримки.

### Принципи інтеграції
- **Слабке зв'язування**: Мінімізація залежностей між системними компонентами
- **Висока згуртованість**: Групування пов'язаної функціональності в межах обмежених контекстів
- **Стійкість**: Проектування для відмов з circuit breakers та повторними спробами
- **Спостережливість**: Комплексне логування, моніторинг та трасування
- **Безпека**: Наскрізна безпека з автентифікацією та авторизацією

---

## 1. Паттерн проектування API

### RESTful сервіси зі специфікацією OpenAPI

Система приймає **підхід REST-first** з комплексною документацією OpenAPI для всіх публічних API.

#### Основні принципи
- **Орієнтованість на ресурси**: URL представляють ресурси, а не дії
- **HTTP семантика**: Правильне використання HTTP методів та кодів статусу
- **Без стану**: Відсутність серверного стану сесії
- **Кешованість**: Підтримка HTTP заголовків кешування
- **Шаровість**: Чітке розділення між рівнями презентації, бізнесу та даних

#### Стандарти реалізації
- **OpenAPI 3.1**: Комплексна документація API
- **JSON**: Основний тип контенту з HAL для гіпермедіа
- **Версіонування**: URI версіонування з зворотною сумісністю
- **Обробка помилок**: RFC 7807 Problem Details для консистентних помилкових відповідей
- **Автентифікація**: JWT Bearer токени з OAuth2
- **Обмеження швидкості**: Дроселювання запитів для запобігання зловживанням

#### Пов'язані ADR
- [ADR-012: Стандарти документації](./adr/ADR-012-Documentation-ua.md)
- [ADR-009: Security Framework](./adr/ADR-009-Security-Framework-ua.md)

---

## 2. Архітектура на основі подій

### Повідомлення на основі Kafka

Система реалізує **паттерни на основі подій** з використанням Apache Kafka для асинхронної комунікації та системної інтеграції.

#### Типи подій
```
award-events/
├── award.created           # Зареєстрована нова нагорода
├── award.updated           # Інформація про нагороду змінена
├── award.approved          # Нагорода затверджена органом влади
├── award.rejected          # Нагорода відхилена
└── award.published         # Нагорода зроблена публічно видимою

user-events/
├── user.registered         # Створений новий обліковий запис користувача
├── user.profile.updated    # Профіль користувача змінений
└── user.deactivated        # Обліковий запис користувача деактивований

document-events/
├── document.uploaded       # Документ завантажений
├── document.processed      # AI обробка завершена
├── document.verified       # Верифікація документа завершена
└── document.indexed        # Документ індексований для пошуку
```

#### Схема подій
```json
{
  "eventType": "award.created",
  "eventId": "uuid",
  "timestamp": "2025-01-16T10:30:00Z",
  "source": "award-service",
  "subject": "award-123",
  "data": {
    "awardId": "123",
    "userId": "456",
    "institutionId": "789",
    "metadata": {}
  },
  "dataContentType": "application/json",
  "specVersion": "1.0"
}
```

#### Шаблони реалізації
- **Event Sourcing**: Підтримка журналу подій для аудиторського сліду
- **CQRS**: Розділення моделей читання та запису для продуктивності
- **Saga Pattern**: Управління розподіленими транзакціями
- **Outbox Pattern**: Забезпечення надійної публікації подій
- **Dead Letter Queue**: Обробка невдалої обробки подій

#### Пов'язані ADR
- [ADR-006: Черга повідомлень](./adr/ADR-006-Message-Queue-ua.md)

---

## 3. Мікросервіси проти модульного монолітного підходу

### Матриця архітектурних рішень

Система приймає підхід **модульного монолітного підходу** спочатку, з підготовкою до майбутньої міграції до мікросервісів.

#### Матриця рішень

| **Критерії** | **Вага** | **Моноліт** | **Мікросервіси** | **Рішення** |
|--------------|------------|--------------|-------------------|--------------|
| **Швидкість розробки** | Висока | 9 | 6 | Моноліт |
| **Соло розробник** | Висока | 9 | 4 | Моноліт |
| **Складність розгортання** | Середня | 8 | 4 | Моноліт |
| **Масштабованість** | Середня | 6 | 9 | Збалансовано |
| **Різноманітність технологій** | Низька | 6 | 9 | Моноліт |
| **Розмір команди** | Висока | 8 | 5 | Моноліт |
| **Цінність портфоліо** | Середня | 6 | 8 | Збалансовано |

**Фінальне рішення**: **Модульний монолітний підхід** з архітектурою, готовою до мікросервісів

#### Межі модулів
- **Чіткі API**: Добре визначені інтерфейси між модулями
- **Незалежні бази даних**: Окремі схеми бази даних для кожного модуля
- **Комунікація на основі подій**: Модулі спілкуються через події
- **Спільна інфраструктура**: Спільне логування, безпека та моніторинг

#### Шлях міграції до мікросервісів
1. **Фаза 1**: Реалізація модульного монолітного підходу з чіткими межами
2. **Фаза 2**: Виділення модулів з інтенсивним читанням (звітування, пошук)
3. **Фаза 3**: Виділення доменних модулів з високою незалежністю
4. **Фаза 4**: Розбиття решти модулів за потребою

---

## 4. Паттерни консистентності даних

### Saga Pattern для розподілених транзакцій

Система реалізує **Saga Pattern** для підтримки консистентності даних через межі модулів без розподілених транзакцій.

#### Saga затвердження нагород
```
Saga створення нагороди:
1. Створити нагороду (Компенсувальна)
2. Валідувати інституцію (Компенсувальна)
3. Обробити документи (Компенсувальна)
4. Надіслати сповіщення (Повторна спроба)
5. Оновити пошуковий індекс (Повторна спроба)
```

#### Типи реалізації Saga
- **Хореографія**: Події запускають наступні кроки
- **Оркестрація**: Центральний координатор керує потоком
- **Гібрид**: Комбінація на основі складності

#### Паттерни компенсації
```java
@Service
public class AwardCreationSaga {
    
    @SagaStep(compensatingMethod = "cancelAwardCreation")
    public void createAward(AwardCreationCommand command) {
        // Логіка створення нагороди
    }
    
    public void cancelAwardCreation(AwardCreationCommand command) {
        // Логіка компенсації
    }
}
```

#### Рівні консистентності даних
- **Сильна консистентність**: Всередині меж модуля з використанням транзакцій бази даних
- **Евентуальна консистентність**: Між модулями з використанням saga паттернів
- **Консистентність читання**: CQRS з моделями читання на основі event sourcing

---

## 5. Паттерни інтеграції безпеки

### Реалізація OAuth2 + JWT + RBAC

Система реалізує комплексну безпеку з використанням **OAuth2 з JWT токенами** та **рольового контролю доступу (RBAC)**.

#### Потік автентифікації
```
1. Вхід користувача → Сервер авторизації
2. Валідація облікових даних → Генерація JWT токена
3. Повернення токена → Клієнтський додаток
4. API запит + JWT → Ресурсний сервер
5. Валідація JWT → Обробка запиту
6. Повернення відповіді → Клієнт
```

#### Структура JWT токена
```json
{
  "header": {
    "alg": "RS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user-id",
    "iss": "award-system",
    "aud": "award-api",
    "exp": 1642781400,
    "iat": 1642777800,
    "roles": ["STUDENT", "AWARD_VIEWER"],
    "permissions": ["award:read", "document:upload"],
    "institution": "university-123"
  }
}
```

#### Реалізація RBAC матриці
```yaml
roles:
  STUDENT:
    permissions:
      - award:create
      - award:read:own
      - document:upload:own
  
  DEPARTMENT_ADMIN:
    inherits: [STUDENT]
    permissions:
      - award:approve:department
      - user:manage:department
  
  UNIVERSITY_ADMIN:
    inherits: [DEPARTMENT_ADMIN]
    permissions:
      - award:approve:university
      - institution:manage
```

#### Паттерни безпеки
- **Zero Trust**: Перевірка кожного запиту незалежно від джерела
- **Принцип найменших привілеїв**: Мінімальні необхідні дозволи
- **Захист в глибину**: Множинні рівні безпеки
- **Безпечно за замовчуванням**: Відмова доступу, якщо не надано явно

#### Пов'язані ADR
- [ADR-009: Security Framework](./adr/ADR-009-Security-Framework-ua.md)

---

## 6. Паттерни якості інтеграції

### Паттерн Circuit Breaker
Захист від каскадних відмов у розподілених системах.

```java
@Component
public class ExternalServiceClient {
    
    @CircuitBreaker(name = "institutional-api", fallbackMethod = "fallbackResponse")
    @Retry(name = "institutional-api")
    @TimeLimiter(name = "institutional-api")
    public CompletableFuture<String> callExternalService() {
        // Виклик зовнішнього сервісу
    }
    
    public CompletableFuture<String> fallbackResponse(Exception ex) {
        return CompletableFuture.completedFuture("Fallback response");
    }
}
```

### Паттерн Bulkhead
Ізоляція критичних ресурсів для запобігання виснаженню ресурсів.

```yaml
spring:
  task:
    execution:
      pool:
        core-size: 8
        max-size: 16
    scheduling:
      pool:
        size: 4
```

### Паттерни повторних спроб та тайм-ауту
Стійка комунікація з зовнішніми системами.

```yaml
resilience4j:
  retry:
    instances:
      institutional-api:
        max-attempts: 3
        wait-duration: 1s
        exponential-backoff-multiplier: 2
  
  timelimiter:
    instances:
      institutional-api:
        timeout-duration: 5s
```

---

## 7. Паттерни моніторингу та спостережливості

### Три стовпи спостережливості

#### 1. Метрики
- **Метрики додатка**: Бізнес KPI та технічні метрики
- **Метрики інфраструктури**: CPU, пам'ять, диск, мережа
- **Користувацькі метрики**: Швидкість обробки нагород, активність користувачів

#### 2. Логування
- **Структуроване логування**: JSON формат для машинної обробки
- **Correlation ID**: Трасування запитів через сервіси
- **Рівні логування**: Відповідне логування для продакшн середовищ

#### 3. Трасування
- **Розподілене трасування**: Наскрізне відстеження запитів
- **Span контекст**: Детальний час операцій та метадані
- **Відстеження помилок**: Автоматичне захоплення помилок та сповіщення

#### Реалізація
```java
@RestController
@Slf4j
public class AwardController {
    
    @GetMapping("/awards/{id}")
    @Timed(name = "award_retrieval_time")
    public ResponseEntity<Award> getAward(@PathVariable String id) {
        log.info("Retrieving award with id: {}", id);
        // Реалізація
    }
}
```

---

## 8. Паттерни тестування

### Реалізація піраміди тестування

#### Unit тести (70%)
- **Швидкі**: < 100ms час виконання
- **Ізольовані**: Без зовнішніх залежностей
- **Фокусовані**: Тестування однієї відповідальності

#### Інтеграційні тести (20%)
- **TestContainers**: Реальна база даних та черга повідомлень
- **API тестування**: Повне тестування HTTP стеку
- **Contract тестування**: Верифікація контрактів API

#### End-to-End тести (10%)
- **Користувацькі подорожі**: Критичні бізнес-потоки
- **Браузерне тестування**: Frontend інтеграція
- **Тестування продуктивності**: Навантажувальне та стрес тестування

---

## Метрики успіху

| **Категорія паттерну** | **Метрика** | **Ціль** | **Вимірювання** |
|---------------------|------------|------------|-----------------|
| **Продуктивність API** | Час відповіді | < 200ms P99 | Метрики додатка |
| **Обробка подій** | Затримка повідомлень | < 5 секунд | Моніторинг Kafka |
| **Стійкість системи** | Рівень помилок | < 0.1% | Відстеження помилок |
| **Безпека** | Невдалі автентифікації | < 5/хвилину | Логи безпеки |
| **Інтеграція** | Circuit Breaker | < 1% відкритого стану | Метрики Resilience4j |

---

## Пов'язані документи

- **Архітектура**: [Вибір технологічного стеку](./TECH_STACK_ua.md)
- **Безпека**: [Security Framework](../compliance/SECURITY_FRAMEWORK_ua.md)
- **Вимоги**: [Бізнес-вимоги](../requirements/BUSINESS_REQUIREMENTS_ua.md)
- **ADR**: [Записи архітектурних рішень](./adr/)