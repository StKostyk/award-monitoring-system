# Словник Даних
## Система Моніторингу та Відстеження Нагород

> **Результат Фази 9**: Архітектура Даних та Проєктування Бази Даних  
> **Версія Документа**: 1.0  
> **Останнє Оновлення**: Грудень 2025  
> **Автор**: Стефан Костик  
> **Загальна Кількість Сутностей**: 14  
> **Класифікація**: Внутрішній

---

## Резюме

Цей Словник Даних надає комплексну документацію для всіх сутностей бази даних у Системі Моніторингу та Відстеження Нагород. Кожна сутність включає визначення атрибутів, типи даних, обмеження, бізнес-правила та зв'язки. Цей документ служить авторитетним довідником для реалізації схеми бази даних під час фази розробки.

### Домени Сутностей

| **Домен** | **Сутності** | **Призначення** |
|-----------|--------------|-----------------|
| **Домен Користувачів** | `users`, `user_roles`, `organizations` | Ідентичність, контроль доступу, організаційна структура |
| **Домен Нагород** | `awards`, `award_categories`, `documents` | Основні бізнес-сутності для управління нагородами |
| **Домен Робочого Процесу** | `award_requests`, `review_decisions` | Відстеження багаторівневого робочого процесу затвердження |
| **Домен Відповідності** | `audit_logs`, `consent_records` | Відповідність GDPR, аудиторські сліди |
| **Домен Сповіщень** | `notifications`, `notification_preferences` | Комунікація та налаштування користувачів |

---

## 1. Домен Користувачів

### 1.1 Сутність: `users`

**Опис**: Центральна сутність ідентичності що представляє всіх користувачів системи включаючи співробітників, адміністраторів та затверджувачів. Містить облікові дані автентифікації та інформацію профілю.

**Бізнес-Правила**:
- Адреса електронної пошти повинна бути унікальною серед усіх користувачів
- Користувачі належать рівно одній первинній організації
- Переходи статусу: PENDING → ACTIVE ↔ INACTIVE → SUSPENDED → RETIRED/MEMORIAL
- Хеш пароля використовує алгоритм BCrypt з силою 12

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `user_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор користувача |
| `email_address` | `VARCHAR(255)` | НІ | - | UK | Email користувача (обліковий запис для входу) |
| `first_name` | `VARCHAR(100)` | НІ | - | - | Ім'я користувача (GDPR: Персональні Дані) |
| `last_name` | `VARCHAR(100)` | НІ | - | - | Прізвище користувача (GDPR: Персональні Дані) |
| `password_hash` | `VARCHAR(255)` | НІ | - | - | BCrypt хешований пароль (GDPR: Конфіденційно) |
| `account_status` | `VARCHAR(20)` | НІ | `'PENDING'` | CK | Стан облікового запису (див. enum нижче) |
| `organization_id` | `BIGINT` | НІ | - | FK→organizations | Первинний організаційний підрозділ |
| `last_login_at` | `TIMESTAMPTZ` | ТАК | - | - | Мітка часу останньої успішної автентифікації |
| `created_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу створення запису |
| `updated_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу останньої модифікації |
| `version` | `BIGINT` | НІ | `1` | - | Версія оптимістичного блокування |

**Значення Статусу** (`account_status`):
| Значення | Опис | Переходить До |
|----------|------|---------------|
| `PENDING` | Очікує верифікації email | ACTIVE |
| `ACTIVE` | Нормальний активний стан | INACTIVE, SUSPENDED |
| `INACTIVE` | Тимчасово відключений | ACTIVE, SUSPENDED |
| `SUSPENDED` | Адміністративне утримання | ACTIVE, RETIRED |
| `RETIRED` | Колишній працівник (доступ тільки для читання) | MEMORIAL |
| `MEMORIAL` | Померлий (нагороди збережені, немає доступу) | - |

**Індекси**:
- `pk_users` - Первинний ключ на `user_id`
- `uk_users_email` - Унікальний на `email_address`
- `idx_users_organization` - B-tree на `organization_id`
- `idx_users_status` - B-tree на `account_status`
- `idx_users_lower_email` - Індекс виразу на `LOWER(email_address)`

**Зв'язки**:
- НАЛЕЖИТЬ ДО `organizations` (N:1) через `organization_id`
- МАЄ БАГАТО `user_roles` (1:N)
- МАЄ БАГАТО `awards` (1:N)
- МАЄ БАГАТО `audit_logs` (1:N)
- МАЄ БАГАТО `consent_records` (1:N)
- МАЄ БАГАТО `notifications` (1:N)

---

### 1.2 Сутність: `user_roles`

**Опис**: Призначення ролей що пов'язують користувачів з конкретними ролями в організаційних контекстах. Підтримує часову дійсність для переходів ролей та відстеження історії.

**Бізнес-Правила**:
- Користувачі можуть мати кілька ролей у різних організаціях
- Період дійсності ролі не може мати `valid_to` до `valid_from`
- Поточні ролі - ті де `valid_to IS NULL OR valid_to >= CURRENT_DATE`
- Ієрархія ролей визначає повноваження затвердження

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `user_role_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор призначення ролі |
| `user_id` | `BIGINT` | НІ | - | FK→users | Користувач що отримує роль |
| `role_type` | `VARCHAR(30)` | НІ | - | CK | Тип ролі (див. enum нижче) |
| `organization_id` | `BIGINT` | НІ | - | FK→organizations | Організаційний обсяг ролі |
| `valid_from` | `DATE` | НІ | `CURRENT_DATE` | - | Дата початку дії ролі |
| `valid_to` | `DATE` | ТАК | - | CK | Дата закінчення дії ролі (NULL=поточна) |
| `created_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу створення запису |
| `created_by` | `BIGINT` | ТАК | - | FK→users | Адмін що призначив роль |

**Типи Ролей** (`role_type`):
| Значення | Опис | Рівень Дозволів |
|----------|------|-----------------|
| `EMPLOYEE` | Стандартний працівник | Подання власних нагород |
| `FACULTY_SECRETARY` | Секретар факультету | Затвердження першого рівня, звіти факультету |
| `DEAN` | Декан факультету | Затвердження другого рівня, управління факультетом |
| `RECTOR_SECRETARY` | Секретар ректора | Затвердження третього рівня, звіти університету |
| `RECTOR` | Ректор університету | Остаточні повноваження затвердження |
| `SYSTEM_ADMIN` | Технічний адміністратор | Конфігурація системи, управління користувачами |
| `GDPR_OFFICER` | Офіцер захисту даних | Відповідність приватності, експорт даних |

**Індекси**:
- `pk_user_roles` - Первинний ключ на `user_role_id`
- `idx_user_roles_user` - B-tree на `user_id`
- `idx_user_roles_org` - B-tree на `organization_id`
- `idx_user_roles_current` - Частковий індекс для активних ролей

**Зв'язки**:
- НАЛЕЖИТЬ ДО `users` (N:1) через `user_id`
- НАЛЕЖИТЬ ДО `organizations` (N:1) через `organization_id`

---

### 1.3 Сутність: `organizations`

**Опис**: Ієрархічна організаційна структура що представляє університет, факультети та кафедри. Самопосилання для зв'язків батько-дитина.

**Бізнес-Правила**:
- Університет є кореневою організацією (без батьківського)
- Факультети належать Університету
- Кафедри належать Факультетам
- Ієрархія організації визначає маршрутизацію робочого процесу затвердження
- Видалення організації вимагає відсутності залежних користувачів

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `org_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор організації |
| `name` | `VARCHAR(255)` | НІ | - | - | Повна назва організації |
| `name_uk` | `VARCHAR(255)` | ТАК | - | - | Українська назва |
| `code` | `VARCHAR(50)` | ТАК | - | UK | Внутрішній код організації |
| `org_type` | `VARCHAR(20)` | НІ | - | CK | Тип рівня організації |
| `parent_org_id` | `BIGINT` | ТАК | - | FK→organizations | Батьківська організація (NULL для кореня) |
| `hierarchy_path` | `LTREE` | ТАК | - | - | Матеріалізований шлях для запитів |
| `depth` | `INTEGER` | НІ | `0` | - | Рівень глибини ієрархії |
| `is_active` | `BOOLEAN` | НІ | `TRUE` | - | Прапор активного статусу |
| `created_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу створення запису |
| `updated_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу останньої модифікації |

**Типи Організацій** (`org_type`):
| Значення | Опис | Глибина |
|----------|------|---------|
| `UNIVERSITY` | Установа верхнього рівня | 0 |
| `FACULTY` | Академічний факультет | 1 |
| `DEPARTMENT` | Академічна кафедра | 2 |

**Індекси**:
- `pk_organizations` - Первинний ключ на `org_id`
- `uk_organizations_code` - Унікальний на `code` (де не null)
- `idx_organizations_parent` - B-tree на `parent_org_id`
- `gist_organizations_path` - GiST на `hierarchy_path` для запитів дерева

**Зв'язки**:
- НАЛЕЖИТЬ ДО `organizations` (N:1, самопосилання) через `parent_org_id`
- МАЄ БАГАТО `organizations` (1:N, дочірні)
- МАЄ БАГАТО `users` (1:N)
- МАЄ БАГАТО `user_roles` (1:N)

---

## 2. Домен Нагород

### 2.1 Сутність: `awards`

**Опис**: Основна бізнес-сутність що представляє професійні досягнення, визнання та нагороди отримані працівниками. Містить як публічну інформацію про нагороду так і метадані.

**Бізнес-Правила**:
- Кожна нагорода належить рівно одному користувачу (отримувачу)
- Нагороди повинні бути категоризовані через `category_id`
- Статус нагороди слідує визначеній прогресії робочого процесу
- Перевірені нагороди відображають бейдж верифікації
- Бал впливу розраховується на основі рівня категорії та організації що нагороджує
- Нагороди публічно видимі (основна функція системи для прозорості)

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `award_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор нагороди |
| `user_id` | `BIGINT` | НІ | - | FK→users | Отримувач нагороди |
| `category_id` | `BIGINT` | НІ | - | FK→award_categories | Класифікація нагороди |
| `title` | `VARCHAR(500)` | НІ | - | - | Назва нагороди |
| `title_uk` | `VARCHAR(500)` | ТАК | - | - | Українська назва |
| `description` | `TEXT` | ТАК | - | - | Детальний опис |
| `description_uk` | `TEXT` | ТАК | - | - | Український опис |
| `awarding_organization` | `VARCHAR(255)` | НІ | - | - | Організація що надала нагороду |
| `award_date` | `DATE` | НІ | - | - | Дата надання нагороди |
| `status` | `VARCHAR(20)` | НІ | `'DRAFT'` | CK | Поточний статус робочого процесу |
| `verification_badge` | `BOOLEAN` | НІ | `FALSE` | - | Перевірено підтверджуючими документами |
| `impact_score` | `INTEGER` | ТАК | - | CK: 0-100 | Розрахований бал значущості |
| `external_url` | `VARCHAR(2048)` | ТАК | - | - | Посилання на зовнішню верифікацію |
| `created_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу створення запису |
| `updated_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу останньої модифікації |
| `version` | `BIGINT` | НІ | `1` | - | Версія оптимістичного блокування |

**Значення Статусу** (`status`):
| Значення | Опис | Переходить До |
|----------|------|---------------|
| `DRAFT` | Початковий стан, редагується | PENDING |
| `PENDING` | Подано, очікує затвердження | APPROVED, REJECTED |
| `APPROVED` | Затверджено через робочий процес | ARCHIVED |
| `REJECTED` | Відхилено під час робочого процесу | DRAFT (повторне подання) |
| `ARCHIVED` | Історичний запис, більше не активний | - |

**Розрахунок Балу Впливу** (0-100):
- Базовий бал з рівня категорії (Кафедра: 20, Факультет: 40, Університет: 60, Національний: 80, Міжнародний: 100)
- Модифікатори на основі престижу організації що нагороджує

**Індекси**:
- `pk_awards` - Первинний ключ на `award_id`
- `idx_awards_user` - B-tree на `user_id`
- `idx_awards_category` - B-tree на `category_id`
- `idx_awards_status` - B-tree на `status`
- `idx_awards_date` - B-tree на `award_date DESC`
- `idx_awards_status_pending` - Частковий індекс де `status = 'PENDING'`
- `ftidx_awards_title` - Повнотекстовий на `title` для пошуку

**Зв'язки**:
- НАЛЕЖИТЬ ДО `users` (N:1) через `user_id`
- НАЛЕЖИТЬ ДО `award_categories` (N:1) через `category_id`
- МАЄ БАГАТО `documents` (1:N)
- МАЄ ОДИН `award_requests` (1:1)

---

### 2.2 Сутність: `award_categories`

**Опис**: Система класифікації нагород що визначає категорії, рівні визнання та вимоги до затвердження.

**Бізнес-Правила**:
- Категорії є ієрархічними (опційна батьківська категорія)
- Рівень визнання визначає мінімальні повноваження затвердження
- Категорії з вищими рівнями вимагають ескалації в робочому процесі
- Системно визначені категорії не можуть бути видалені

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `category_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор категорії |
| `name` | `VARCHAR(100)` | НІ | - | UK | Назва категорії (Англійська) |
| `name_uk` | `VARCHAR(100)` | ТАК | - | - | Назва категорії (Українська) |
| `description` | `TEXT` | ТАК | - | - | Опис категорії |
| `level` | `VARCHAR(20)` | НІ | - | CK | Рівень визнання |
| `parent_category_id` | `BIGINT` | ТАК | - | FK→award_categories | Батьківська категорія |
| `sort_order` | `INTEGER` | НІ | `0` | - | Порядок відображення |
| `is_active` | `BOOLEAN` | НІ | `TRUE` | - | Активний статус |
| `is_system` | `BOOLEAN` | НІ | `FALSE` | - | Системно визначений (не видаляється) |
| `created_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу створення запису |
| `updated_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу останньої модифікації |

**Рівні Визнання** (`level`):
| Значення | Опис | Мінімальний Рівень Затвердження |
|----------|------|--------------------------------|
| `DEPARTMENT` | Визнання на рівні кафедри | Секретар Факультету |
| `FACULTY` | Визнання на рівні факультету | Декан |
| `UNIVERSITY` | Визнання на рівні університету | Ректор |
| `NATIONAL` | Визнання на національному рівні | Ректор |
| `INTERNATIONAL` | Міжнародне визнання | Ректор |

**Індекси**:
- `pk_award_categories` - Первинний ключ на `category_id`
- `uk_award_categories_name` - Унікальний на `name`
- `idx_award_categories_level` - B-tree на `level`
- `idx_award_categories_parent` - B-tree на `parent_category_id`

**Зв'язки**:
- НАЛЕЖИТЬ ДО `award_categories` (N:1, самопосилання) через `parent_category_id`
- МАЄ БАГАТО `award_categories` (1:N, дочірні)
- МАЄ БАГАТО `awards` (1:N)

---

### 2.3 Сутність: `documents`

**Опис**: Метадані файлів для підтверджуючих документів прикріплених до нагород. Фактичні файли зберігаються в об'єктному сховищі (S3/Azure Blob). Включає результати AI-парсингу метаданих.

**Бізнес-Правила**:
- Документи належать або нагороді або запиту (або обом)
- Максимальний розмір файлу: 10МБ на документ
- Дозволені типи файлів: PDF, JPG, PNG, WEBP
- AI парсинг витягує метадані зі сканованих сертифікатів
- Бал впевненості нижче 0.7 запускає ручну перевірку
- Файли зберігаються в object storage, тільки метадані в базі даних

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `document_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор документа |
| `award_id` | `BIGINT` | ТАК | - | FK→awards | Пов'язана нагорода |
| `request_id` | `BIGINT` | ТАК | - | FK→award_requests | Пов'язаний запит |
| `file_name` | `VARCHAR(255)` | НІ | - | - | Оригінальна назва файлу |
| `file_type` | `VARCHAR(50)` | НІ | - | CK | Розширення файлу |
| `mime_type` | `VARCHAR(100)` | ТАК | - | - | MIME тип вмісту |
| `file_size` | `BIGINT` | НІ | - | CK: ≤10485760 | Розмір файлу в байтах |
| `storage_bucket` | `VARCHAR(100)` | НІ | - | - | Назва бакету об'єктного сховища |
| `storage_key` | `VARCHAR(500)` | НІ | - | - | Ключ/шлях об'єктного сховища |
| `storage_url` | `VARCHAR(2048)` | ТАК | - | - | Попередньо підписаний URL доступу |
| `checksum_sha256` | `VARCHAR(64)` | ТАК | - | - | Контрольна сума цілісності файлу |
| `parsed_metadata` | `JSONB` | ТАК | - | - | AI-витягнуті метадані |
| `confidence_score` | `NUMERIC(5,4)` | ТАК | - | CK: 0-1 | Впевненість AI (0.0000-1.0000) |
| `processing_status` | `VARCHAR(20)` | НІ | `'PENDING'` | CK | Стан обробки AI |
| `processed_at` | `TIMESTAMPTZ` | ТАК | - | - | Час завершення обробки AI |
| `uploaded_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу завантаження |
| `uploaded_by` | `BIGINT` | НІ | - | FK→users | ID користувача що завантажив |

**Значення Статусу Обробки** (`processing_status`):
| Значення | Опис | Наступні Стани |
|----------|------|----------------|
| `PENDING` | Очікує обробки AI | PROCESSING |
| `PROCESSING` | Поточно обробляється | COMPLETED, FAILED |
| `COMPLETED` | Успішно оброблено | VERIFIED |
| `FAILED` | Помилка обробки | PENDING (повтор) |
| `MANUAL_REVIEW` | Низька впевненість, потребує перевірки людиною | VERIFIED |
| `VERIFIED` | Метадані перевірені людиною | - |

**Структура JSONB Витягнутих Метаданих**:
```json
{
  "extracted_title": "Сертифікат Досягнення",
  "extracted_date": "2024-03-15",
  "extracted_organization": "Міністерство Освіти",
  "extracted_recipient": "Іван Петренко",
  "language_detected": "uk",
  "document_type": "certificate",
  "extraction_version": "1.0"
}
```

**Індекси**:
- `pk_documents` - Первинний ключ на `document_id`
- `idx_documents_award` - B-tree на `award_id`
- `idx_documents_request` - B-tree на `request_id`
- `idx_documents_status` - B-tree на `processing_status`
- `gin_documents_metadata` - GIN на `parsed_metadata`

**Зв'язки**:
- НАЛЕЖИТЬ ДО `awards` (N:1) через `award_id`
- НАЛЕЖИТЬ ДО `award_requests` (N:1) через `request_id`
- НАЛЕЖИТЬ ДО `users` (N:1) через `uploaded_by`

---

## 3. Домен Робочого Процесу

### 3.1 Сутність: `award_requests`

**Опис**: Сутність відстеження робочого процесу для процесу затвердження нагород. Кожна нагорода має рівно один запит що відстежує її шлях через багаторівневий робочий процес затвердження.

**Бізнес-Правила**:
- Зв'язок один-до-одного з нагородами (кожна нагорода має рівно один запит)
- Рівні робочого процесу: Секретар Факультету → Декан → Секретар Ректора → Ректор
- Ескалація на основі рівня визнання категорії нагороди
- Терміни розраховуються на основі вимог SLA
- Закінчення терміну запиту якщо не оброблено в межах дедлайну

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `request_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор запиту |
| `award_id` | `BIGINT` | НІ | - | FK→awards, UK | Пов'язана нагорода (унікальний) |
| `submitter_id` | `BIGINT` | НІ | - | FK→users | Користувач що подав |
| `status` | `VARCHAR(20)` | НІ | `'SUBMITTED'` | CK | Поточний статус запиту |
| `current_reviewer_id` | `BIGINT` | ТАК | - | FK→users | Поточний призначений рецензент |
| `current_level` | `VARCHAR(30)` | НІ | - | CK | Поточний рівень затвердження |
| `submitted_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу подання |
| `deadline` | `TIMESTAMPTZ` | ТАК | - | - | Термін обробки |
| `completed_at` | `TIMESTAMPTZ` | ТАК | - | - | Мітка часу остаточного рішення |
| `rejection_reason` | `TEXT` | ТАК | - | - | Причина якщо відхилено |
| `created_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу створення запису |
| `updated_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу останньої модифікації |

**Значення Статусу Запиту** (`status`):
| Значення | Опис | Переходить До |
|----------|------|---------------|
| `SUBMITTED` | Початкове подання | IN_REVIEW |
| `IN_REVIEW` | Поточно розглядається | ESCALATED, APPROVED, REJECTED, RETURNED |
| `ESCALATED` | Переміщено на вищий рівень затвердження | IN_REVIEW |
| `APPROVED` | Остаточне затвердження надано | - |
| `REJECTED` | Остаточне відхилення | - |
| `RETURNED` | Повернуто для виправлень | SUBMITTED |
| `EXPIRED` | Дедлайн минув без рішення | - |

**Рівні Затвердження** (`current_level`):
| Значення | Опис | Наступний Рівень |
|----------|------|------------------|
| `FACULTY_SECRETARY` | Початкова перевірка | DEAN |
| `DEAN` | Затвердження рівня факультету | RECTOR_SECRETARY |
| `RECTOR_SECRETARY` | Перевірка офісу ректора | RECTOR |
| `RECTOR` | Остаточні повноваження затвердження | - |

**Індекси**:
- `pk_award_requests` - Первинний ключ на `request_id`
- `uk_award_requests_award` - Унікальний на `award_id`
- `idx_award_requests_status` - B-tree на `status`
- `idx_award_requests_reviewer` - B-tree на `current_reviewer_id`
- `idx_award_requests_deadline` - B-tree на `deadline`
- `idx_award_requests_active` - Частковий індекс для активних запитів

**Зв'язки**:
- НАЛЕЖИТЬ ДО `awards` (1:1) через `award_id`
- НАЛЕЖИТЬ ДО `users` (N:1) через `submitter_id`
- НАЛЕЖИТЬ ДО `users` (N:1) через `current_reviewer_id`
- МАЄ БАГАТО `review_decisions` (1:N)
- МАЄ БАГАТО `documents` (1:N)

---

### 3.2 Сутність: `review_decisions`

**Опис**: Індивідуальні рішення затвердження/відхилення прийняті на кожному рівні робочого процесу. Надає повний аудиторський слід процесу затвердження.

**Бізнес-Правила**:
- Кожне рішення прив'язане до одного запиту та одного рецензента
- Типи рішень: APPROVED, REJECTED, ESCALATED, RETURNED
- Рішення є незмінними після запису
- Коментарі обов'язкові для відхилень та повернень
- Мітка часу записує точний момент рішення

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `decision_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор рішення |
| `request_id` | `BIGINT` | НІ | - | FK→award_requests | Пов'язаний запит |
| `reviewer_id` | `BIGINT` | НІ | - | FK→users | Приймач рішення |
| `decision` | `VARCHAR(20)` | НІ | - | CK | Тип рішення |
| `level` | `VARCHAR(30)` | НІ | - | CK | Рівень затвердження при рішенні |
| `comments` | `TEXT` | ТАК | - | - | Коментарі рецензента |
| `decided_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу рішення |

**Типи Рішень** (`decision`):
| Значення | Опис | Статус Запиту Після |
|----------|------|---------------------|
| `APPROVED` | Затверджено на цьому рівні | ESCALATED або APPROVED (остаточний) |
| `REJECTED` | Відхилено на цьому рівні | REJECTED |
| `ESCALATED` | Вручну ескальовано на вищий рівень | ESCALATED |
| `RETURNED` | Повернуто подавачу для виправлень | RETURNED |

**Індекси**:
- `pk_review_decisions` - Первинний ключ на `decision_id`
- `idx_review_decisions_request` - B-tree на `request_id`
- `idx_review_decisions_reviewer` - B-tree на `reviewer_id`
- `idx_review_decisions_decided` - B-tree на `decided_at DESC`

**Зв'язки**:
- НАЛЕЖИТЬ ДО `award_requests` (N:1) через `request_id`
- НАЛЕЖИТЬ ДО `users` (N:1) через `reviewer_id`

---

## 4. Домен Відповідності

### 4.1 Сутність: `audit_logs`

**Опис**: Комплексний аудиторський слід для всіх значних дій системи. Потрібен для відповідності GDPR та моніторингу безпеки.

**Бізнес-Правила**:
- Всі модифікації даних логуються автоматично через тригери
- Журнали є незмінними (UPDATE/DELETE не дозволено)
- Період зберігання: 7 років (згідно вимог GDPR)
- Партиціонування за місяць для продуктивності
- Зберігає як старі так і нові значення для відстеження змін

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `log_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор журналу |
| `user_id` | `BIGINT` | ТАК | - | FK→users | Користувач що виконав дію (NULL для системи) |
| `action_type` | `VARCHAR(50)` | НІ | - | - | Тип виконаної дії |
| `entity_type` | `VARCHAR(50)` | НІ | - | - | Сутність/таблиця що постраждала |
| `entity_id` | `BIGINT` | ТАК | - | - | ID постраждалого запису |
| `old_values` | `JSONB` | ТАК | - | - | Попередні значення (для UPDATE/DELETE) |
| `new_values` | `JSONB` | ТАК | - | - | Нові значення (для INSERT/UPDATE) |
| `changed_fields` | `TEXT[]` | ТАК | - | - | Список змінених назв колонок |
| `ip_address` | `INET` | ТАК | - | - | IP адреса клієнта (GDPR: Технічний ID) |
| `user_agent` | `VARCHAR(500)` | ТАК | - | - | User agent клієнта |
| `correlation_id` | `UUID` | ТАК | - | - | Кореляція запиту для трасування |
| `created_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу запису журналу |

**Типи Дій** (поширені значення):
- `CREATE`, `UPDATE`, `DELETE` - CRUD операції
- `LOGIN`, `LOGOUT`, `LOGIN_FAILED` - Автентифікація
- `PASSWORD_CHANGE`, `PASSWORD_RESET` - Безпека
- `CONSENT_GRANTED`, `CONSENT_WITHDRAWN` - Приватність
- `DATA_EXPORT`, `DATA_DELETE` - Права GDPR
- `APPROVAL`, `REJECTION` - Рішення робочого процесу

**Індекси**:
- `pk_audit_logs` - Первинний ключ на `(log_id, created_at)` (партиціонований)
- `idx_audit_logs_user` - B-tree на `user_id`
- `idx_audit_logs_entity` - B-tree на `(entity_type, entity_id)`
- `idx_audit_logs_timestamp` - B-tree на `created_at DESC`
- `idx_audit_logs_action` - B-tree на `action_type`

**Партиціонування**:
- Партиціоновано за `RANGE (created_at)`
- Місячні партиції для ефективного управління зберіганням

**Зв'язки**:
- НАЛЕЖИТЬ ДО `users` (N:1) через `user_id`

---

### 4.2 Сутність: `consent_records`

**Опис**: Відповідне до GDPR відстеження згоди для угод обробки даних користувачів. Записує всі надання та відкликання згоди.

**Бізнес-Правила**:
- Кожен тип згоди відстежується окремо для кожного користувача
- Версія згоди відстежується для оновлень політики
- Мітка часу відкликання зберігається для аудиту
- Згода потрібна перед обробкою персональних даних
- Історичні записи згоди ніколи не видаляються

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `consent_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор запису згоди |
| `user_id` | `BIGINT` | НІ | - | FK→users | Користувач що надає згоду |
| `consent_type` | `VARCHAR(50)` | НІ | - | CK | Тип згоди |
| `consent_version` | `VARCHAR(20)` | НІ | - | - | Версія політики на яку дана згода |
| `is_granted` | `BOOLEAN` | НІ | - | - | Поточний стан згоди |
| `granted_at` | `TIMESTAMPTZ` | ТАК | - | - | Мітка часу коли надана |
| `withdrawn_at` | `TIMESTAMPTZ` | ТАК | - | - | Мітка часу коли відкликана |
| `ip_address` | `INET` | ТАК | - | - | IP на момент дії |
| `user_agent` | `VARCHAR(500)` | ТАК | - | - | Інформація браузера/клієнта |
| `created_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу створення запису |

**Типи Згоди** (`consent_type`):
| Значення | Опис | Обов'язковий |
|----------|------|--------------|
| `DATA_PROCESSING` | Загальна угода обробки даних | Так |
| `PUBLIC_VISIBILITY` | Дозволити публічне відображення нагород | Так |
| `EMAIL_NOTIFICATIONS` | Отримувати email сповіщення | Ні |
| `SMS_NOTIFICATIONS` | Отримувати SMS сповіщення | Ні |
| `ANALYTICS` | Дозволити аналітику використання | Ні |

**Індекси**:
- `pk_consent_records` - Первинний ключ на `consent_id`
- `idx_consent_records_user` - B-tree на `user_id`
- `idx_consent_records_user_type` - Композитний на `(user_id, consent_type)`
- `idx_consent_records_active` - Частковий для активних згод

**Зв'язки**:
- НАЛЕЖИТЬ ДО `users` (N:1) через `user_id`

---

## 5. Домен Сповіщень

### 5.1 Сутність: `notifications`

**Опис**: Системні сповіщення що надсилаються користувачам про активність нагород, оновлення робочого процесу та системні попередження.

**Бізнес-Правила**:
- Сповіщення створюються системними подіями (не користувачем)
- Непрочитані сповіщення виділяються в UI
- Сповіщення поважають налаштування користувача
- Доставка через кілька каналів (in-app, email, SMS)
- Період зберігання: 1 рік

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `notification_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор сповіщення |
| `user_id` | `BIGINT` | НІ | - | FK→users | Користувач отримувач |
| `type` | `VARCHAR(50)` | НІ | - | CK | Тип сповіщення |
| `title` | `VARCHAR(255)` | НІ | - | - | Заголовок сповіщення |
| `message` | `TEXT` | НІ | - | - | Повне повідомлення сповіщення |
| `is_read` | `BOOLEAN` | НІ | `FALSE` | - | Статус прочитання |
| `channel` | `VARCHAR(20)` | НІ | `'IN_APP'` | CK | Канал доставки |
| `reference_type` | `VARCHAR(50)` | ТАК | - | - | Тип пов'язаної сутності |
| `reference_id` | `BIGINT` | ТАК | - | - | ID пов'язаної сутності |
| `sent_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу відправлення |
| `read_at` | `TIMESTAMPTZ` | ТАК | - | - | Коли позначено як прочитане |
| `expires_at` | `TIMESTAMPTZ` | ТАК | - | - | Закінчення терміну сповіщення |

**Типи Сповіщень** (`type`):
| Значення | Опис | Тригер Події |
|----------|------|--------------|
| `AWARD_SUBMITTED` | Нова нагорода подана | Подання нагороди |
| `AWARD_APPROVED` | Нагорода затверджена | Остаточне затвердження |
| `AWARD_REJECTED` | Нагорода відхилена | Рішення про відхилення |
| `AWARD_RETURNED` | Нагорода повернута для виправлень | Рішення про повернення |
| `REVIEW_ASSIGNED` | Призначено рецензентом | Призначення в робочому процесі |
| `DEADLINE_REMINDER` | Наближається дедлайн | Запланована задача |
| `SYSTEM_ALERT` | Системне оголошення | Дія адміністратора |

**Канали Сповіщень** (`channel`):
| Значення | Опис |
|----------|------|
| `IN_APP` | Сповіщення в застосунку |
| `EMAIL` | Доставка email |
| `SMS` | Доставка SMS |
| `PUSH` | Push сповіщення |

**Індекси**:
- `pk_notifications` - Первинний ключ на `notification_id`
- `idx_notifications_user` - B-tree на `user_id`
- `idx_notifications_user_unread` - Частковий для непрочитаних сповіщень
- `idx_notifications_sent` - B-tree на `sent_at DESC`
- `idx_notifications_reference` - Композитний на `(reference_type, reference_id)`

**Зв'язки**:
- НАЛЕЖИТЬ ДО `users` (N:1) через `user_id`

---

### 5.2 Сутність: `notification_preferences`

**Опис**: Налаштування користувачів для каналів доставки сповіщень за типом події.

**Бізнес-Правила**:
- Налаштування за замовчуванням створюються при реєстрації користувача
- Користувачі можуть змінювати налаштування в будь-який час
- Щонайменше один канал повинен бути увімкнений для обов'язкових сповіщень
- Налаштування поважаються сервісом сповіщень

| **Колонка** | **Тип Даних** | **Nullable** | **За Замовч.** | **Обмеження** | **Опис** |
|-------------|---------------|--------------|----------------|---------------|----------|
| `preference_id` | `BIGSERIAL` | НІ | Авто | PK | Унікальний ідентифікатор налаштування |
| `user_id` | `BIGINT` | НІ | - | FK→users | Користувач власник налаштування |
| `event_type` | `VARCHAR(50)` | НІ | - | CK | Тип події сповіщення |
| `email_enabled` | `BOOLEAN` | НІ | `TRUE` | - | Канал email увімкнений |
| `sms_enabled` | `BOOLEAN` | НІ | `FALSE` | - | Канал SMS увімкнений |
| `in_app_enabled` | `BOOLEAN` | НІ | `TRUE` | - | Канал в застосунку увімкнений |
| `push_enabled` | `BOOLEAN` | НІ | `FALSE` | - | Push сповіщення увімкнені |
| `created_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу створення запису |
| `updated_at` | `TIMESTAMPTZ` | НІ | `CURRENT_TIMESTAMP` | - | Мітка часу останньої модифікації |

**Індекси**:
- `pk_notification_preferences` - Первинний ключ на `preference_id`
- `uk_notification_preferences_user_event` - Унікальний на `(user_id, event_type)`
- `idx_notification_preferences_user` - B-tree на `user_id`

**Зв'язки**:
- НАЛЕЖИТЬ ДО `users` (N:1) через `user_id`

---

## 6. Зведення Зв'язків Сутностей

### 6.1 Матриця Зв'язків

| **Сутність** | **Зв'язки** |
|--------------|-------------|
| `users` | → organizations (N:1), ← user_roles (1:N), ← awards (1:N), ← audit_logs (1:N), ← consent_records (1:N), ← notifications (1:N), ← notification_preferences (1:N) |
| `user_roles` | → users (N:1), → organizations (N:1) |
| `organizations` | → organizations (N:1, само), ← organizations (1:N), ← users (1:N), ← user_roles (1:N) |
| `awards` | → users (N:1), → award_categories (N:1), ← documents (1:N), ← award_requests (1:1) |
| `award_categories` | → award_categories (N:1, само), ← award_categories (1:N), ← awards (1:N) |
| `documents` | → awards (N:1), → award_requests (N:1), → users (N:1) |
| `award_requests` | → awards (1:1), → users (N:1, submitter), → users (N:1, reviewer), ← review_decisions (1:N), ← documents (1:N) |
| `review_decisions` | → award_requests (N:1), → users (N:1) |
| `audit_logs` | → users (N:1) |
| `consent_records` | → users (N:1) |
| `notifications` | → users (N:1) |
| `notification_preferences` | → users (N:1) |

### 6.2 Зведення Кардинальності

| **Зв'язок** | **Кардинальність** | **Примітки** |
|-------------|-------------------|-------------|
| Користувач → Організація | N:1 | Обов'язковий |
| Користувач → Нагороди | 1:N | Нагороди працівника |
| Нагорода → Запит | 1:1 | Унікальний запит на нагороду |
| Запит → Рішення | 1:N | Кілька рішень за рівень |
| Нагорода → Документи | 1:N | Підтверджуючі документи |
| Організація → Організація | N:1 (само) | Ієрархія |

---

## Додаток A: Швидкий Довідник Типів Даних

| **Бізнес Концепція** | **Тип PostgreSQL** | **Тип Java** |
|---------------------|-------------------|--------------|
| Первинний Ключ | `BIGSERIAL` | `Long` |
| Зовнішній Ключ | `BIGINT` | `Long` |
| Короткий Рядок | `VARCHAR(n)` | `String` |
| Довгий Текст | `TEXT` | `String` |
| Email | `VARCHAR(255)` | `String` |
| Статус/Enum | `VARCHAR(30)` | `Enum` |
| Булевий | `BOOLEAN` | `Boolean` |
| Дата | `DATE` | `LocalDate` |
| Мітка Часу | `TIMESTAMPTZ` | `Instant` |
| Гроші | `NUMERIC(19,4)` | `BigDecimal` |
| JSON Дані | `JSONB` | `JsonNode` |
| IP Адреса | `INET` | `String` |
| Розмір Файлу | `BIGINT` | `Long` |
| Бал (0-100) | `INTEGER` | `Integer` |
| Впевненість (0-1) | `NUMERIC(5,4)` | `BigDecimal` |

---

## Додаток B: Зведення Правил Валідації

| **Сутність** | **Поле** | **Правило Валідації** |
|--------------|----------|----------------------|
| `users` | `email_address` | Дійсний формат email, макс 255 символів |
| `users` | `first_name` | Обов'язковий, макс 100 символів |
| `users` | `last_name` | Обов'язковий, макс 100 символів |
| `users` | `password_hash` | Формат BCrypt |
| `awards` | `title` | Обов'язковий, макс 500 символів |
| `awards` | `award_date` | Не може бути майбутньою датою |
| `awards` | `impact_score` | Діапазон 0-100 |
| `documents` | `file_size` | Макс 10,485,760 байт (10МБ) |
| `documents` | `file_type` | Один з: PDF, JPG, PNG, WEBP |
| `documents` | `confidence_score` | Діапазон 0.0000-1.0000 |
| `consent_records` | `consent_version` | Формат Semver (напр., "1.0.0") |

---

*Версія Документа: 1.0*  
*Класифікація: Внутрішній*  
*Фаза: 9 - Архітектура Даних та Проєктування Бази Даних*  
*Автор: Стефан Костик*
