# =============================================================================
# Award Monitoring System - Logstash Pipeline Configuration
# =============================================================================

input {
  # TCP input for JSON logs from Spring Boot
  tcp {
    port => 5000
    codec => json_lines
    tags => ["springboot"]
  }

  # UDP input as fallback
  udp {
    port => 5000
    codec => json_lines
    tags => ["springboot"]
  }

  # Beats input for Filebeat integration
  beats {
    port => 5044
  }
}

filter {
  # Parse Spring Boot JSON logs
  if "springboot" in [tags] {
    # Extract fields from JSON
    if [message] {
      json {
        source => "message"
        target => "parsed"
        skip_on_invalid_json => true
      }
    }

    # Copy parsed fields to root
    if [parsed] {
      mutate {
        rename => {
          "[parsed][timestamp]" => "log_timestamp"
          "[parsed][level]" => "log_level"
          "[parsed][logger_name]" => "logger"
          "[parsed][message]" => "log_message"
          "[parsed][thread_name]" => "thread"
          "[parsed][trace_id]" => "trace_id"
          "[parsed][span_id]" => "span_id"
          "[parsed][user_id]" => "user_id"
          "[parsed][request_id]" => "request_id"
        }
        remove_field => ["parsed"]
      }
    }

    # Parse timestamp
    if [log_timestamp] {
      date {
        match => ["log_timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ"]
        target => "@timestamp"
      }
    }

    # Add severity level for Kibana
    if [log_level] {
      mutate {
        add_field => {
          "severity" => "%{log_level}"
        }
      }
      
      # Normalize log levels
      if [severity] == "WARN" {
        mutate { update => { "severity" => "WARNING" } }
      }
    }

    # Extract exception info
    if [stack_trace] {
      mutate {
        add_tag => ["exception"]
      }
    }
  }

  # Add metadata
  mutate {
    add_field => {
      "application" => "award-monitoring-system"
      "environment" => "${ENVIRONMENT:development}"
    }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => ["host", "port", "@version"]
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "award-logs-%{+YYYY.MM.dd}"
    template_name => "award-logs"
    template_overwrite => true
  }

  # Debug output (development only)
  # stdout {
  #   codec => rubydebug
  # }
}

